# Chat App API

Lightweight chat backend written in Go. Clients can create ad-hoc rooms, connect via WebSocket, and exchange real-time messages. This document covers the available HTTP endpoints, their request/response formats, and how to interact with the WebSocket gateway.

## Server Overview

- Default listen address: `:8080`
- Rooms are created on demand and removed automatically once the last participant disconnects.
- Usernames are optional; missing names are replaced with a random default.

## REST Endpoints

### Create a Room — `POST /rooms`

Creates a new chat room. The request body is optional and can carry additional metadata that will be echoed back when the room is queried.

#### Request

```http
POST /rooms HTTP/1.1
Content-Type: application/json

{
  "title": "General discussion",
  "topic": "Release planning"
}
```

- Body: arbitrary JSON object (may be empty). Values are stored as-is under `additionalInfo`.

#### Successful Response — `200 OK`

```json
{
  "roomID": 1
}
```

#### Error Responses

- `400 Bad Request` if the JSON payload cannot be decoded.

### List Rooms — `GET /rooms`

Retrieves all currently active rooms.

#### Successful Response — `200 OK`

```json
{
  "rooms": [
    {
      "id": 1,
      "onlineUser": 3,
      "additionalInfo": {
        "title": "General discussion"
      }
    }
  ]
}
```

### Get Room Details — `GET /rooms/{roomID}`

Returns metadata for a specific room.

- `roomID`: numeric path parameter.

#### Successful Response — `200 OK`

```json
{
  "id": 1,
  "additionalInfo": {
    "title": "General discussion"
  }
}
```

#### Error Responses

- `400 Bad Request` if `roomID` is not a positive integer.
- `404 Not Found` if the room does not exist (either never created or already removed).

### Join Room Socket — `GET /join/{roomID}?user=<name>`

Upgrades the connection to WebSocket and joins the requested room.

- `roomID`: numeric path parameter.
- `user`: optional query parameter. If omitted, the server assigns a random display name.

#### WebSocket Message Flow

- Upon joining, the server broadcasts a system message to all connected clients:

  ```json
  {
    "type": "system",
    "message": "Alice joined room 1",
    "timestamp": "2024-04-09T12:34:56.789012345Z",
    "user": {
      "id": "dd0a6c0c-7b01-47d4-8b3a-296774a0930c",
      "name": "system"
    }
  }
  ```

- Clients send chat messages as plain text frames. Each text frame is wrapped by the server into a JSON payload and broadcast to all participants:

  ```json
  {
    "type": "message",
    "message": "Hello everyone!",
    "timestamp": "2024-04-09T12:35:10.123456789Z",
    "user": {
      "id": "9a6e58a5-4d47-4c86-8b3f-9ea373cbdb0c",
      "name": "Alice"
    }
  }
  ```

- The connection stays alive via periodic ping/pong frames initiated by the server every 30 seconds.

#### Error Responses

- `400 Bad Request` if `roomID` cannot be parsed.
- `404 Not Found` if the room is missing.
- Standard WebSocket close frames for protocol errors or unexpected disconnects.

### Build Information — `GET /info`

Exposes metadata about the running binary.

#### Successful Response — `200 OK`

```json
{
  "version": "unknown",
  "commit": "unknown",
  "branch": "unknown",
  "repository": "unknown",
  "build_time": "2024-04-09T12:45:00Z"
}
```

- Field values are populated at build time; when unavailable, they default to `"unknown"`.

### Health Check — `GET /healthz`

Simple liveness probe.

#### Successful Response — `200 OK`

Plain-text body: `OK`

## Message Schema Reference

| Field          | Type     | Description                                             |
| -------------- | -------- | ------------------------------------------------------- |
| `type`         | string   | `"system"` for server notices, `"message"` for user chat |
| `message`      | string   | Message body or informational text                      |
| `timestamp`    | RFC3339  | Time generated by the server                            |
| `user.id`      | UUID     | Unique identifier assigned per connection               |
| `user.name`    | string   | Display name (random fallback if not supplied)          |

## Lifecycle Notes

- Rooms are deleted automatically once all clients disconnect.
- Each WebSocket connection corresponds to a single user identity; reconnecting generates a new UUID.
- Additional room metadata is stored without validation—sanitize user-provided fields on the client if needed.
